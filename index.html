<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Free Resume Audit Tool ‚Äî Chance Create</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap');

  :root {
    --bg: #fffbf5;
    --surface: #ffffff;
    --surface2: #f4ecf8;
    --accent: #ceb1dd;
    --accent-deep: #9b6dbb;
    --muted: #95897a;
    --text: #242424;
    --border: #e8e0f0;
    --success: #7aab8a;
    --warn: #c97a3a;
    --danger: #e05252;
    --radius: 14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    width: 100%;
    max-width: 800px;
    padding: 56px 24px 32px;
    text-align: center;
  }
  .eyebrow {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent-deep);
    margin-bottom: 14px;
  }
  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 900;
    line-height: 1.1;
    color: var(--text);
    margin-bottom: 16px;
  }
  h1 em { color: var(--accent-deep); font-style: normal; }
  .subtitle {
    font-size: 15px;
    color: var(--muted);
    max-width: 500px;
    margin: 0 auto;
    line-height: 1.75;
  }

  .main {
    width: 100%;
    max-width: 800px;
    padding: 32px 24px 80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 44px 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s;
    background: var(--surface);
    position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: rgba(206,177,221,0.05);
  }
  .upload-zone input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }
  .upload-icon { font-size: 32px; margin-bottom: 10px; }
  .upload-zone h3 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
  .upload-zone p { font-size: 13px; color: var(--muted); }
  .file-status {
    margin-top: 12px;
    font-size: 13px;
    font-weight: 500;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .file-status.active { display: flex; }
  .file-status.success { color: var(--success); }
  .file-status.error { color: var(--danger); }

  .divider {
    display: flex;
    align-items: center;
    gap: 14px;
    color: var(--muted);
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .field { display: flex; flex-direction: column; gap: 7px; }
  .field label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
  }
  .field input, .field textarea {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 9px;
    padding: 12px 15px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
    resize: vertical;
  }
  .field input:focus, .field textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(206,177,221,0.2);
  }
  .field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  @media (max-width: 580px) { .field-row { grid-template-columns: 1fr; } }

  .btn-primary {
    background: var(--accent-deep);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 17px 32px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn-primary:hover { background: #8559a8; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(155,109,187,0.3); }
  .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }

  .error-box {
    display: none;
    background: rgba(224,82,82,0.08);
    border: 1px solid rgba(224,82,82,0.25);
    border-radius: 9px;
    padding: 14px 18px;
    font-size: 14px;
    color: #c0392b;
    line-height: 1.6;
  }
  .error-box.active { display: block; }

  .loading {
    display: none;
    text-align: center;
    padding: 56px 24px;
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }
  .loading.active { display: block; }
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent-deep);
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading p { color: var(--muted); font-size: 14px; }
  .loading p strong { color: var(--text); }

  .results { display: none; flex-direction: column; gap: 18px; }
  /* ‚îÄ‚îÄ HEADLINE INSIGHT ‚îÄ‚îÄ */
  .headline-insight {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-left: 4px solid var(--accent-deep);
    border-radius: 12px;
    padding: 20px 24px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }
  .headline-insight-icon { font-size: 22px; line-height: 1; flex-shrink: 0; margin-top: 2px; }
  .headline-insight-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent-deep); margin-bottom: 8px; }
  .headline-insight-text { font-size: 15px; line-height: 1.7; color: var(--text); font-style: italic; }
  
  /* ‚îÄ‚îÄ WHAT RECRUITERS SEE ‚îÄ‚îÄ */
  .human-signal-card {
    background: rgba(206,177,221,0.13);
    border: 1.5px solid rgba(206,177,221,0.4);
    border-radius: 12px;
    overflow: hidden;
  }
  .human-signal-header {
    padding: 18px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  .human-signal-header:hover { background: rgba(206,177,221,0.12); }
  .human-signal-title { font-size: 13px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--accent-deep); }
  .human-signal-chevron { font-size: 12px; color: var(--accent-deep); transition: transform 0.3s ease; }
  .human-signal-chevron.open { transform: rotate(180deg); }
  .human-signal-body {
    display: none;
    padding: 0 24px 20px 24px;
    font-size: 15px;
    line-height: 1.75;
    color: var(--text);
  }
  
  /* ‚îÄ‚îÄ WHAT THE ATS SEES ‚îÄ‚îÄ */
  .ats-flags-card {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .ats-flags-header {
    padding: 18px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  .ats-flags-header:hover { background: rgba(0,0,0,0.03); }
  .ats-flags-title { font-size: 13px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text); }
  .ats-flags-count {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 20px;
    margin-left: 10px;
    background: rgba(224,82,82,0.1);
    color: var(--danger);
  }
  .ats-flags-count.clean { background: rgba(122,171,138,0.15); color: var(--success); }
  .ats-flags-chevron { font-size: 12px; color: var(--muted); transition: transform 0.3s ease; }
  .ats-flags-chevron.open { transform: rotate(180deg); }
  .ats-flags-body { display: none; padding: 0 24px 20px 24px; }
  .ats-flag-item {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .ats-flag-item:last-child { border-bottom: none; }
  .ats-risk-badge {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 6px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .ats-risk-badge.high { background: rgba(224,82,82,0.12); color: var(--danger); }
  .ats-risk-badge.medium { background: rgba(201,122,58,0.12); color: var(--warn); }
  .ats-risk-badge.low { background: rgba(122,171,138,0.15); color: var(--success); }
  .ats-flag-content {}
  .ats-flag-name { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
  .ats-flag-fix { font-size: 13px; color: var(--muted); line-height: 1.5; }
  
  .results.active { display: flex; }

  .score-banner {
    border-radius: var(--radius);
    padding: 24px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .score-banner.recruiter-ready { background: rgba(122,171,138,0.12); border: 1.5px solid rgba(122,171,138,0.35); }
  .score-banner.strong { background: rgba(206,177,221,0.15); border: 1.5px solid rgba(206,177,221,0.4); }
  .score-banner.decent { background: rgba(201,122,58,0.1); border: 1.5px solid rgba(201,122,58,0.3); }
  .score-banner.needs-work { background: rgba(224,82,82,0.08); border: 1.5px solid rgba(224,82,82,0.25); }
  .score-label {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 4px;
  }
  .score-value {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 700;
  }
  .score-banner.recruiter-ready .score-value { color: var(--success); }
  .score-banner.strong .score-value { color: var(--accent-deep); }
  .score-banner.decent .score-value { color: var(--warn); }
  .score-banner.needs-work .score-value { color: var(--danger); }
  .score-icon { font-size: 2.2rem; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 26px;
  }
  .card-title {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent-deep);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 7px;
  }
  .card-body {
    font-size: 14px;
    line-height: 1.8;
    color: #4a4440;
  }

  .issue-list { list-style: none; display: flex; flex-direction: column; gap: 9px; }
  .issue-item {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    padding: 13px 16px;
    background: #faf7fc;
    border-radius: 9px;
    border-left: 3px solid var(--border);
    font-size: 13.5px;
    line-height: 1.65;
    color: var(--text);
  }
  .issue-item.critical { border-left-color: var(--danger); }
  .issue-item.warning { border-left-color: var(--warn); }
  .issue-item.tip { border-left-color: var(--success); }
  .issue-tag {
    font-size: 9px;
    font-weight: 800;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 3px 9px;
    border-radius: 4px;
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .issue-item.critical .issue-tag { background: rgba(224,82,82,0.12); color: var(--danger); }
  .issue-item.warning .issue-tag { background: rgba(201,122,58,0.12); color: var(--warn); }
  .issue-item.tip .issue-tag { background: rgba(122,171,138,0.12); color: var(--success); }

  /* ‚îÄ‚îÄ ISSUES COLLAPSIBLE ‚îÄ‚îÄ */
  .issues-card {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .issues-header {
    padding: 18px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  .issues-header:hover { background: rgba(0,0,0,0.03); }
  .issues-header-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .issues-title { font-size: 13px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text); }
  .issues-pill {
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 20px;
    letter-spacing: 0.04em;
  }
  .issues-pill.critical { background: rgba(224,82,82,0.12); color: var(--danger); }
  .issues-pill.warning { background: rgba(201,122,58,0.12); color: var(--warn); }
  .issues-pill.tip { background: rgba(122,171,138,0.15); color: var(--success); }
  .issues-chevron { font-size: 12px; color: var(--muted); transition: transform 0.3s ease; }
  .issues-chevron.open { transform: rotate(180deg); }
  .issues-body { display: none; padding: 0 24px 20px 24px; }

  /* ‚îÄ‚îÄ REALITY CHECK ‚îÄ‚îÄ */
  .reality-check {
    background: rgba(201,122,58,0.07);
    border: 1.5px solid rgba(201,122,58,0.25);
    border-radius: 12px;
    padding: 24px;
  }
  .reality-check-label {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--warn);
    margin-bottom: 16px;
  }
  .reality-check-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
  }
  @media (max-width: 640px) {
    .reality-check-grid { grid-template-columns: 1fr; }
  }
  .reality-check-col-title {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: var(--text);
    margin-bottom: 8px;
  }
  .reality-check-col-body {
    font-size: 14px;
    line-height: 1.7;
    color: var(--muted);
  }

  .resume-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  
  .resume-wrap-header {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 14px 22px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
  }
  .resume-wrap-header span {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent-deep);
  }
  .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn-sm {
    background: var(--surface);
    border: 1.5px solid var(--border);
    color: var(--text);
    border-radius: 7px;
    padding: 7px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .btn-sm:hover { border-color: var(--accent-deep); color: var(--accent-deep); }
  .btn-sm.success { border-color: var(--success); color: var(--success); }

  .resume-output {
    padding: 40px 44px;
    font-family: 'Times New Roman', Georgia, serif;
    font-size: 10.5pt;
    line-height: 1.6;
    color: #1a1a1a;
    white-space: pre-wrap;
    word-break: break-word;
  }
  @media (max-width: 580px) { .resume-output { padding: 24px 20px; } }

  .btn-reset {
    background: transparent;
    border: 1.5px solid var(--border);
    color: var(--muted);
    border-radius: 8px;
    padding: 11px 24px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    align-self: center;
  }
  .btn-reset:hover { border-color: var(--text); color: var(--text); }

  footer {
    text-align: center;
    padding: 28px 24px 40px;
    color: var(--muted);
    font-size: 12px;
    border-top: 1px solid var(--border);
    width: 100%;
    max-width: 800px;
  }
  footer a { color: var(--accent-deep); text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  /* EMAIL GATE */
  .email-gate {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(36,36,36,0.6);
    backdrop-filter: blur(4px);
    z-index: 100;
    align-items: flex-start;
    justify-content: center;
    padding: 24px;
    overflow-y: auto;
  }
  .email-gate.active { display: flex; }
  .email-gate-box {
    background: #fffbf5;
    border-radius: 18px;
    padding: 44px 40px;
    max-width: 460px;
    width: 100%;
    text-align: center;
    box-shadow: 0 24px 60px rgba(36,36,36,0.18);
    animation: gateIn 0.25s ease;
    margin: auto;
  }
  @keyframes gateIn {
    from { transform: scale(0.94); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .email-gate-icon { font-size: 2.4rem; margin-bottom: 12px; }
  .email-gate-box h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 900;
    color: #242424;
    margin-bottom: 10px;
    line-height: 1.2;
  }
  .email-gate-box h2 em { color: #9b6dbb; font-style: normal; }
  .email-gate-box p {
    font-size: 14px;
    color: #95897a;
    line-height: 1.7;
    margin-bottom: 24px;
  }
  .email-gate-fields {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 14px;
  }
  .email-gate-fields input {
    background: #fff;
    border: 1.5px solid #e8e0f0;
    border-radius: 9px;
    padding: 13px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: #242424;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }
  .email-gate-fields input:focus {
    border-color: #ceb1dd;
    box-shadow: 0 0 0 3px rgba(206,177,221,0.2);
  }
  .btn-unlock {
    background: #9b6dbb;
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 15px 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-bottom: 10px;
  }
  .btn-unlock:hover { background: #8559a8; transform: translateY(-1px); }
  .btn-unlock:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .email-gate-skip {
    font-size: 15px;
    font-weight: 600;
    color: var(--accent-deep);
    cursor: pointer;
    text-decoration: none;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    padding: 12px 24px;
    margin-top: 8px;
    width: 100%;
    transition: all 0.2s;
  }
  .email-gate-skip:hover {
    border-color: var(--accent-deep);
    background: var(--surface);
    transform: translateY(-1px);
  }
  .email-gate-error {
    font-size: 13px;
    color: #e05252;
    margin-top: 8px;
    display: none;
  }
  .email-gate-error.active { display: block; }
  .email-gate-privacy {
    font-size: 11px;
    color: #b0a898;
    margin-top: 12px;
    line-height: 1.6;
  }

  /* GATE SUCCESS STATE */
  .gate-success {
    display: none;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 14px;
    padding: 8px 0;
  }
  .gate-success.active { display: flex; }
  .gate-success-icon { font-size: 44px; }
  .gate-success h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: var(--text);
    margin: 0;
    line-height: 1.3;
  }
  .gate-success h3 em { color: var(--accent-deep); font-style: normal; }
  .gate-success-sub { font-size: 13px; color: var(--muted); margin: 0; }
  .gate-success-steps {
    background: var(--surface2);
    border-radius: 12px;
    padding: 16px 18px;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 12px;
    text-align: left;
  }
  .gate-success-step {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    font-size: 13px;
    color: var(--text);
    line-height: 1.55;
  }
  .gate-step-num {
    background: var(--accent-deep);
    color: #fff;
    border-radius: 50%;
    min-width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    margin-top: 1px;
    flex-shrink: 0;
  }
  .gate-success-btn {
    background: var(--accent-deep);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 13px 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
    margin-top: 4px;
  }
  .gate-success-btn:hover { background: #8559a8; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(155,109,187,0.3); }

  /* OPTIONAL FIELDS HINT */
  .optional-hint {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.5;
  }
  .optional-hint-icon { font-size: 15px; flex-shrink: 0; }
  .field-optional { font-size: 11px; color: var(--muted); font-weight: 400; margin-left: 4px; }

  /* SCORE PERCENT BADGE */
  .score-percent-badge {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent-deep);
    background: var(--surface2);
    padding: 4px 12px;
    border-radius: 20px;
    margin-top: 6px;
    display: inline-block;
  }

  /* NEW AUDIT BAR ‚Äî shown at top of form when user has a session */
  .new-audit-bar {
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    background: linear-gradient(135deg, var(--surface2) 0%, #ede4f5 100%);
    border: 1.5px solid var(--accent);
    border-radius: var(--radius);
    padding: 14px 20px;
    flex-wrap: wrap;
  }
  .new-audit-bar.active { display: flex; }
  .new-audit-bar-text {
    font-size: 14px;
    color: var(--text);
    line-height: 1.5;
  }
  .new-audit-bar-text strong { color: var(--accent-deep); }
  .new-audit-bar-text span { font-size: 12px; color: var(--muted); display: block; margin-top: 2px; }
  .btn-new-audit {
    background: var(--accent-deep);
    color: white;
    border: none;
    border-radius: 9px;
    padding: 10px 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .btn-new-audit:hover { background: #8559a8; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(155,109,187,0.25); }

  /* RESULTS FOOTER ‚Äî new audit + sign out at bottom of results */
  .results-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    padding-top: 4px;
  }
  .btn-new-audit-lg {
    background: var(--accent-deep);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 14px 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    flex: 1;
    min-width: 200px;
  }
  .btn-new-audit-lg:hover { background: #8559a8; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(155,109,187,0.3); }
  .btn-sign-out {
    background: transparent;
    border: 1.5px solid var(--border);
    color: var(--muted);
    border-radius: 8px;
    padding: 11px 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-sign-out:hover { border-color: var(--danger); color: var(--danger); }

  /* GUEST SAVE PROMPT */
  .guest-save-prompt {
    display: none;
    background: linear-gradient(135deg, var(--surface2) 0%, #f0e8f8 100%);
    border: 1.5px solid var(--accent);
    border-radius: var(--radius);
    padding: 20px 24px;
    text-align: center;
  }
  .guest-save-prompt.active { display: block; }
  .guest-save-prompt p { font-size: 14px; color: var(--text); margin: 0 0 14px 0; line-height: 1.6; }
  .guest-save-prompt p strong { color: var(--accent-deep); }
  .guest-save-prompt-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--accent-deep);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 11px 24px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .guest-save-prompt-btn:hover { background: #8559a8; transform: translateY(-1px); }
  .guest-save-prompt-dismiss {
    display: block;
    margin-top: 10px;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    background: none;
    border: none;
    font-family: 'DM Sans', sans-serif;
  }
  .guest-save-prompt-dismiss:hover { color: var(--text); }

  /* SIGNIN BAR */
  .signin-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 16px;
    padding: 12px 20px;
    background: var(--surface2);
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  .signin-bar-text { font-size: 14px; color: var(--muted); }
  .signin-bar a {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-deep);
    text-decoration: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 7px 16px;
    background: white;
    border: 1.5px solid var(--accent);
    border-radius: 7px;
    transition: all 0.2s;
  }
  .signin-bar a:hover { background: var(--accent-deep); color: white; border-color: var(--accent-deep); }

  /* ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ */
  .history-panel {
    display: none;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .history-panel.active { display: block; }
  .history-header {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .history-header-label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent-deep);
  }
  .history-header-email { font-size: 12px; color: var(--muted); }
  .history-list { display: flex; flex-direction: column; }

  /* History Card */
  .history-card { border-bottom: 1px solid var(--border); overflow: hidden; }
  .history-card:last-child { border-bottom: none; }

  .history-card-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: background 0.15s;
    gap: 12px;
    user-select: none;
  }
  .history-card-header:hover { background: var(--surface2); }
  .history-card-left { flex: 1; min-width: 0; }
  .history-card-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
    flex-wrap: wrap;
  }
  .history-card-score {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 700;
  }
  .history-card-score.recruiter-ready { color: var(--success); }
  .history-card-score.strong { color: var(--accent-deep); }
  .history-card-score.decent { color: var(--warn); }
  .history-card-score.needs-work { color: var(--danger); }
  .history-card-percent {
    font-size: 12px;
    font-weight: 700;
    padding: 2px 9px;
    border-radius: 20px;
    background: var(--surface2);
    color: var(--accent-deep);
    border: 1px solid var(--border);
  }
  .history-card-role {
    font-size: 12px;
    color: var(--muted);
    font-weight: 500;
    background: var(--surface2);
    padding: 2px 8px;
    border-radius: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
  }
  .history-card-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .history-card-date { font-size: 12px; color: var(--muted); }
  .history-card-preview {
    font-size: 12px;
    color: var(--danger);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 280px;
  }
  .history-card-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .history-card-delta {
    font-size: 11px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 8px;
  }
  .history-card-delta.up { color: var(--success); background: rgba(122,171,138,0.12); }
  .history-card-delta.down { color: var(--danger); background: rgba(224,82,82,0.08); }
  .history-card-chevron {
    font-size: 11px;
    color: var(--muted);
    transition: transform 0.25s;
    display: inline-block;
  }
  .history-card.open .history-card-chevron { transform: rotate(180deg); }

  /* Expanded body */
  .history-card-body {
    display: none;
    padding: 0 20px 20px;
    border-top: 1px solid var(--border);
    background: #faf7fd;
  }
  .history-card.open .history-card-body { display: block; }
  .history-card-section { margin-top: 16px; }
  .history-card-section-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }
  .history-issue-list { display: flex; flex-direction: column; gap: 7px; }
  .history-issue {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    font-size: 13px;
    color: var(--text);
    line-height: 1.5;
  }
  .history-issue-tag {
    font-size: 9px;
    font-weight: 800;
    text-transform: uppercase;
    padding: 2px 7px;
    border-radius: 4px;
    flex-shrink: 0;
    margin-top: 2px;
    letter-spacing: 0.05em;
  }
  .history-issue-tag.critical { background: rgba(224,82,82,0.1); color: var(--danger); }
  .history-issue-tag.warning  { background: rgba(201,122,58,0.1); color: var(--warn); }
  .history-issue-tag.tip      { background: rgba(122,171,138,0.1); color: var(--success); }

  .history-resume-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 600;
    color: var(--accent-deep);
    cursor: pointer;
    background: none;
    border: 1.5px solid var(--accent);
    border-radius: 8px;
    padding: 7px 14px;
    margin-top: 4px;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .history-resume-toggle:hover { background: var(--surface2); transform: translateY(-1px); }
  .history-resume-box {
    display: none;
    margin-top: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
    font-size: 12px;
    line-height: 1.7;
    color: var(--text);
    white-space: pre-wrap;
    font-family: 'DM Sans', sans-serif;
    max-height: 320px;
    overflow-y: auto;
  }
  .history-resume-box.open { display: block; }
  .history-empty { padding: 24px 20px; font-size: 14px; color: var(--muted); text-align: center; }
</style>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@9.5.3/build/index.js"></script>
</head>
<body>

<header>
  <p class="eyebrow">Chance Create &middot; Free Resume Audit Tool</p>
  <h1>Your Resume Should<br><em>Open Doors in 10 Seconds.</em></h1>
  <p class="subtitle">Upload your resume and get a recruiter's-eye audit plus a fully rewritten version &mdash; ATS-ready, impact-led, and built to pass the 10-second scan.</p>
  <div class="signin-bar" id="signinBar">
    <span class="signin-bar-text">Already used this tool?</span>
    <a onclick="showSigninGate()">&#128272; View your audit history</a>
  </div>
</header>

<div class="main">

  <!-- History Panel (shown for returning users) -->
  <div class="history-panel" id="historyPanel">
    <div class="history-header">
      <span class="history-header-label">&#128198; Your Past Audits</span>
      <span class="history-header-email" id="historyUser"></span>
    </div>
    <div class="history-list" id="historyList">
      <div class="history-empty">No past audits yet &mdash; run your first one below!</div>
    </div>
  </div>

  <!-- New Audit Bar ‚Äî visible when user has active session -->
  <div class="new-audit-bar" id="newAuditBar">
    <div class="new-audit-bar-text">
      <strong>&#10003; Your last audit is saved.</strong>
      <span>Ready to audit a new resume? Your history is tracked above.</span>
    </div>
    <button class="btn-new-audit" onclick="startNewAudit()">&#43; New Audit</button>
  </div>

  <div class="upload-zone" id="dropZone">
    <input type="file" id="fileInput" accept=".pdf,.txt">
    <div class="upload-icon">&#128196;</div>
    <h3>Drop your resume here or click to upload</h3>
    <p>PDF or plain text (.txt) &mdash; max 5MB</p>
    <p class="file-status" id="fileStatus"></p>
  </div>

  <div class="divider">or paste your resume below</div>

  <div class="field">
    <label>Resume Text</label>
    <textarea id="resumeText" placeholder="Paste your full resume here..." rows="5"></textarea>
  </div>

  <div class="optional-hint">
    <span class="optional-hint-icon">&#128161;</span>
    <span>The more context you give, the sharper your audit. All fields below are optional.</span>
  </div>

  <div class="field-row">
    <div class="field">
      <label>Target Role / Job Title <span class="field-optional">(optional)</span></label>
      <input type="text" id="targetRole" placeholder="e.g. Mainframe Systems Programmer">
    </div>
    <div class="field">
      <label>Industry / Sector <span class="field-optional">(optional)</span></label>
      <input type="text" id="industry" placeholder="e.g. Financial Technology">
    </div>
  </div>

  <div class="field">
    <label>Anything specific to flag? <span class="field-optional">(optional)</span></label>
    <input type="text" id="focusNote" placeholder="e.g. career gap, pivot from non-tech, ATS rejections">
  </div>

  <!-- FUTURE: JD Match input ‚Äî hidden until V3 -->
  <div id="jdMatchSection" style="display:none;">
    <div class="field">
      <label>Job Description <span class="field-optional">(paste to get a match score)</span></label>
      <textarea id="jobDescription" placeholder="Paste the job description here..." rows="4"></textarea>
    </div>
  </div>

  <div class="error-box" id="errorBox"></div>

  <button class="btn-primary" id="analyzeBtn" onclick="analyzeResume()">
    Audit My Resume &rarr;
  </button>

  <div class="loading" id="loading">
      <div class="spinner"></div>
      <p><strong>Reading your resume like a recruiter would&hellip;</strong></p>
      <p style="margin-top:6px;">This takes about 15&ndash;25 seconds. Hang tight.</p>
      <div id="recruitFact" style="
        margin-top: 20px;
        font-size: 13px;
        color: var(--accent-deep);
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px 18px;
        max-width: 420px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.6;
        transition: opacity 0.5s ease;
        opacity: 1;
      "></div>
  </div>

  <div class="results" id="results">
    <div id="scoreBannerRoot"></div>

    <div class="headline-insight" id="headlineInsightBlock" style="display:none;">
      <div class="headline-insight-icon">‚ú¶</div>
      <div class="headline-insight-body">
        <div class="headline-insight-label">Recruiter's Take ‚Äî Just for You</div>
        <div class="headline-insight-text" id="headlineInsightText"></div>
      </div>
    </div>
    
  <div class="issues-card" id="issuesCard">
    <div class="issues-header" onclick="toggleIssues()">
      <div class="issues-header-left">
        <span class="issues-title">‚ö† What's Costing You Interviews</span>
        <span id="issuesPillCritical" class="issues-pill critical" style="display:none;"></span>
        <span id="issuesPillWarning" class="issues-pill warning" style="display:none;"></span>
        <span id="issuesPillTip" class="issues-pill tip" style="display:none;"></span>
      </div>
      <span class="issues-chevron" id="issuesChevron">‚ñº</span>
    </div>
    <div class="issues-body" id="issuesBody">
      <ul class="issue-list" id="issueList"></ul>
    </div>
  </div>

  <div class="reality-check" id="realityCheckBlock" style="display:none;">
    <div class="reality-check-label">üéØ Reality Check</div>
    <div class="reality-check-grid">
      <div>
        <div class="reality-check-col-title">In Your Control</div>
        <div class="reality-check-col-body" id="rcControl"></div>
      </div>
      <div>
        <div class="reality-check-col-title">Market Context</div>
        <div class="reality-check-col-body" id="rcMarket"></div>
      </div>
      <div>
        <div class="reality-check-col-title">Beyond the Resume</div>
        <div class="reality-check-col-body" id="rcBeyond"></div>
      </div>
    </div>
   </div>
    
    <div class="human-signal-card" id="humanSignalCard" style="display:none;">
    <div class="human-signal-header" onclick="toggleHumanSignal()">
      <span class="human-signal-title">üëÅ What Recruiters Actually See</span>
      <span class="human-signal-chevron" id="humanSignalChevron">‚ñº</span>
    </div>
      <div class="human-signal-body" id="humanSignalBody"></div>
    </div>
    
    <div class="card" data-section="ten-second">
      <div class="card-title">&#9889; The 10-Second Scan Test</div>
      <div class="card-body" id="tenSecondResult"></div>
    </div>

    <div class="ats-flags-card" id="atsFlagsCard" style="display:none;">
      <div class="ats-flags-header" onclick="toggleAtsFlags()">
        <div style="display:flex; align-items:center;">
          <span class="ats-flags-title">ü§ñ What the ATS Sees</span>
          <span class="ats-flags-count" id="atsFlagsCount"></span>
        </div>
        <span class="ats-flags-chevron" id="atsFlagsChevron">‚ñº</span>
      </div>
      <div class="ats-flags-body" id="atsFlagsBody"></div>
    </div>

    <!-- FUTURE: JD Match ‚Äî hidden until V3 -->
    <div class="card" id="jdMatchCard" data-section="jd-match" style="display:none;">
      <div class="card-title">&#127919; Job Description Match</div>
      <div class="card-body" id="jdMatchResult"></div>
    </div>

    <!-- FUTURE: Role Discovery ‚Äî hidden until V3 -->
    <div class="card" id="roleDiscoveryCard" data-section="role-discovery" style="display:none;">
      <div class="card-title">&#128269; Roles You May Not Have Considered</div>
      <div class="card-body" id="roleDiscoveryResult"></div>
    </div>
  
    <div class="issues-card" id="resumeCard" style="display:none;">
    <div class="issues-header" onclick="toggleResume()">
      <div class="issues-header-left">
        <span class="issues-title">&#10022; Rewritten Resume</span>
      </div>
      <span class="issues-chevron" id="resumeChevron">‚ñº</span>
    </div>
    <div class="issues-body" id="resumeBody">
      <div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
        <button class="btn-sm" id="copyBtn" onclick="copyResume()">&#128203; Copy Plain Text</button>
        <button class="btn-sm" id="downloadDocxBtn" onclick="downloadResumePDF()">&#8595; Download PDF</button>
      </div>
      <div class="resume-output" id="revisedResume"></div>
    </div>
   </div>

    <!-- Guest save prompt -->
    <div class="guest-save-prompt" id="guestSavePrompt">
      <p>&#128190; <strong>Want to save this audit and track your progress?</strong><br>
      Create a free account with your email and see how your score improves over time.</p>
      <button class="guest-save-prompt-btn" onclick="showGuestSignup()">&#128274; Save My Audit &rarr;</button>
      <button class="guest-save-prompt-dismiss" onclick="dismissSavePrompt()">No thanks, I'll skip saving</button>
    </div>

    <!-- Results footer -->
    <div class="results-footer" id="resultsFooter">
      <button class="btn-new-audit-lg" onclick="startNewAudit()">&#43; Audit Another Resume</button>
      <button class="btn-sign-out" onclick="signOut()" id="signOutBtn" style="display:none;">Sign Out</button>
    </div>
  </div>

  <!-- Sign In Gate -->
  <div class="email-gate" id="signinGate">
    <div class="email-gate-box">
      <div class="email-gate-icon">&#128075;&#127999;</div>
      <h2>Welcome back.<br><em>Sign in to continue.</em></h2>
      <p>Enter the email you used before to see your audit history.</p>
      <div class="email-gate-fields">
        <input type="email" id="signinEmail" placeholder="Your email address" autocomplete="email">
      </div>
      <button class="btn-unlock" onclick="submitSignin()">Sign In &rarr;</button>
      <div class="email-gate-error" id="signinError"></div>
      <button class="email-gate-skip" onclick="closeSignin()">Cancel</button>
    </div>
  </div>

  <!-- Email Gate Modal -->
  <div class="email-gate" id="emailGate">
    <div class="email-gate-box">
      <div class="email-gate-icon">&#128275;</div>
      <h2>Your audit is ready.<br><em>Get instant access.</em></h2>
      <p>Drop your email to unlock your results &mdash; plus get recruiter insights, career reinvention tips, and real talk from someone who's hired for Fortune 500 companies and made her own career pivot.</p>
      <div class="email-gate-fields">
        <input type="text" id="gateName" placeholder="First name" autocomplete="given-name">
        <input type="email" id="gateEmail" placeholder="Your email address" autocomplete="email">
      </div>
      <button class="btn-unlock" id="unlockBtn" onclick="submitEmailGate()">
        Unlock My Resume Audit &rarr;
      </button>
      <div class="email-gate-error" id="gateError"></div>
      <button class="email-gate-skip" onclick="skipEmailGate()">No thanks, just show me the results</button>
      <p class="email-gate-privacy">No spam. Unsubscribe anytime. Your info stays with Chance Create&trade;.</p>

      <!-- Success state -->
      <div class="gate-success" id="gateSuccess">
        <div class="gate-success-icon">&#127881;</div>
        <h3>You&#8217;re in, <em id="successFirstName">friend</em>!</h3>
        <p class="gate-success-sub">Check your inbox &mdash; your Career Reinvention Roadmap is on its way.</p>
        <div class="gate-success-steps">
          <div class="gate-success-step">
            <div class="gate-step-num">1</div>
            <div><strong>Check your email</strong> &mdash; your free Career Reinvention Roadmap has recruiter insider tips you can use today.</div>
          </div>
          <div class="gate-success-step">
            <div class="gate-step-num">2</div>
            <div><strong>Start with critical issues</strong> &mdash; those are what&#8217;s costing you interviews right now.</div>
          </div>
          <div class="gate-success-step">
            <div class="gate-step-num">3</div>
            <div><strong>Download your rewritten resume</strong> &mdash; it&#8217;s ATS-ready and built to pass the 10-second scan.</div>
          </div>
          <div class="gate-success-step">
            <div class="gate-step-num">4</div>
            <div><strong>Come back anytime</strong> &mdash; sign in with this email to track your score over time.</div>
          </div>
        </div>
        <button class="gate-success-btn" onclick="closeSuccessAndShowResults()">
          View My Audit Report &#8594;
        </button>
      </div>
    </div>
  </div>

</div>

<footer>
  Built for <a href="https://chancecreate.com">Chance Create&trade;</a> &middot; Career Reinvention Tools for Real People &middot; Not generic advice.
</footer>

<script>
  const fileInput = document.getElementById('fileInput');
  const dropZone = document.getElementById('dropZone');
  const fileStatus = document.getElementById('fileStatus');
  let uploadedText = '';
  let pendingResults = null;
  var currentUserEmail = null;

  // ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
  (async function loadConfig() {
    try {
      var res = await fetch('/api/getConfig');
      var text = await res.text();
      if (!text || text.trim().startsWith('<')) return;
      var config = JSON.parse(text);
      window.__SB_URL__ = config.supabaseUrl;
      window.__SB_KEY__ = config.supabaseKey;
    } catch(e) {
      console.warn('Config load error:', e.message);
    }
  })();

  // ‚îÄ‚îÄ FILE HANDLING ‚îÄ‚îÄ
  dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change', function() {
    if (fileInput.files[0]) handleFile(fileInput.files[0]);
  });

  function setFileStatus(msg, type) {
    fileStatus.textContent = msg;
    fileStatus.className = 'file-status active ' + (type || '');
  }

  async function handleFile(file) {
    setFileStatus('Extracting text from ' + file.name + '...', '');
    uploadedText = '';
    try {
      if (file.type === 'text/plain') {
        uploadedText = await file.text();
        setFileStatus('‚úÖ ' + file.name + ' ‚Äî ready', 'success');
      } else if (file.type === 'application/pdf') {
        uploadedText = await extractPdfText(file);
        setFileStatus('‚úÖ ' + file.name + ' ‚Äî text extracted', 'success');
      } else {
        setFileStatus('‚ö†Ô∏è Only PDF or .txt supported ‚Äî paste your text below instead', 'error');
      }
    } catch(e) {
      setFileStatus('‚ö†Ô∏è Could not read file ‚Äî paste your resume text below instead', 'error');
      uploadedText = '';
    }
  }

  async function extractPdfText(file) {
    return new Promise(function(resolve, reject) {
      var reader = new FileReader();
      reader.onload = async function(e) {
        try {
          var typedArray = new Uint8Array(e.target.result);
          var pdfjsLib = window['pdfjs-dist/build/pdf'];
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          var pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
          var fullText = '';
          for (var i = 1; i <= pdf.numPages; i++) {
            var page = await pdf.getPage(i);
            var content = await page.getTextContent();
            fullText += content.items.map(function(item) { return item.str; }).join(' ') + '\n';
          }
          resolve(fullText.trim());
        } catch(err) { reject(err); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ
  async function analyzeResume() {
    var pasteText = document.getElementById('resumeText').value.trim();
    var targetRole = document.getElementById('targetRole').value.trim();
    var industry = document.getElementById('industry').value.trim();
    var focusNote = document.getElementById('focusNote').value.trim();
    var errorBox = document.getElementById('errorBox');

    errorBox.classList.remove('active');
    errorBox.textContent = '';

    var resumeContent = uploadedText || pasteText;
    if (!resumeContent) {
      errorBox.textContent = 'Please upload a resume or paste your resume text before analyzing.';
      errorBox.classList.add('active');
      return;
    }

    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('loading').classList.add('active');
    document.getElementById('results').classList.remove('active');
    startFactRotation();

    try {
      var prompt = buildPrompt(resumeContent, targetRole, industry, focusNote);
      var response = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: [{ role: 'user', content: prompt }] })
      });

      // Check for non-JSON responses before attempting parse
      var responseText = await response.text();
      if (!response.ok || responseText.trim().startsWith('<')) {
        if (response.status === 504) throw new Error('The audit timed out ‚Äî please try again in a moment.');
        if (response.status === 502) throw new Error('Server error ‚Äî please try again in a moment.');
        throw new Error('Something went wrong (status ' + response.status + '). Please try again.');
      }

      var data;
      try { data = JSON.parse(responseText); }
      catch(e) { throw new Error('Could not read server response. Please try again.'); }

      if (data.error) throw new Error(typeof data.error === 'object' ? JSON.stringify(data.error) : data.error);
      if (data.type === 'overloaded_error' || (data.error && data.error.type === 'overloaded_error')) {
        throw new Error('The AI is experiencing high demand right now. Wait 30 seconds and try again.');
      }

      // Extract the audit JSON from the Anthropic response envelope
      // data = { content: [{type:'text', text:'{"score":...}'}], ... }
      var raw = (data.content || []).map(function(c) { return c.text || ''; }).join('');
      if (!raw) throw new Error('Empty response ‚Äî please try again.');

      // Extract outermost JSON object
      var jsonMatch = raw.match(/\{[\s\S]*\}/);
      if (!jsonMatch) throw new Error('No JSON found in response.');

      // Only strip true control characters ‚Äî do NOT touch newlines or content
      var cleaned = jsonMatch[0]
        .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, ' ');

      var parsed;
      try {
        parsed = JSON.parse(cleaned);
      } catch(parseErr) {
        console.warn('Full parse failed:', parseErr.message);
        throw new Error('Could not read audit response ‚Äî please try again.');
      }
      showEmailGate(parsed);

    } catch (err) {
      errorBox.textContent = err.message || 'Something went wrong. Please try again.';
      errorBox.classList.add('active');
    } finally {
      document.getElementById('analyzeBtn').disabled = false;
      document.getElementById('loading').classList.remove('active');
      stopFactRotation();
    }
  }

  // ‚îÄ‚îÄ PROMPT BUILDER ‚îÄ‚îÄ
  function buildPrompt(resumeText, targetRole, industry, focusNote) {
    var text = resumeText.slice(0, 4000);
    var prompt = 'Audit this resume and return ONLY a single valid JSON object. No markdown, no backticks, no extra text.\n\n';
    prompt += 'RESUME:\n' + text + '\n\n';
    prompt += 'TARGET ROLE: ' + (targetRole || 'Not specified') + '\n';
    prompt += 'INDUSTRY: ' + (industry || 'Not specified') + '\n';
    if (focusNote) prompt += 'SPECIAL FOCUS: ' + focusNote + '\n';
    prompt += '\nCRITICAL RULES ‚Äî follow exactly:\n';
    prompt += '\n0. SCORE FIELD\n';
    prompt += '   - The score field MUST be EXACTLY one of these four values:\n';
    prompt += '   - "Recruiter Ready" | "Strong" | "Decent Foundation" | "Needs Work"\n';
    prompt += '   - NEVER use: Good, Fair, Average, Poor, Excellent, Needs Improvement, or any other label\n';
    prompt += '\n1. COMPANY GROUPING\n';
    prompt += '   - Group all roles at the same company under ONE company name\n';
    prompt += '   - NEVER repeat the company name between roles\n';
    prompt += '   - Format: COMPANY NAME\\nTitle | City, State\\nStart ‚Äì End\\n‚Ä¢ bullet\\n\\nNext Title | City, State\\nStart ‚Äì End\\n‚Ä¢ bullet\n';
    prompt += '\n2. ROLE TITLE FORMAT\n';
    prompt += '   - ALWAYS use a pipe | between job title and location\n';
    prompt += '   - Example: Customer Success Manager | Tampa, FL\n';
    prompt += '   - The pipe | separator is REQUIRED between every job title and location. Never put title and location on the same line without it.\n';
    prompt += '\n3. DATES ‚Äî always use en dash: 2022 ‚Äì 2024, not 2022 - 2024\n';
    prompt += '\n4. OLDER ROLES ‚Äî do NOT fabricate bullets for vague older experience\n';
    prompt += '\n5. CHRONOLOGICAL ORDER ‚Äî in the rewritten resume, ALWAYS sort all roles with the most recent first (reverse chronological). UST Xpanxion 2024 comes before Intuit 2022, which comes before TD Bank 2021, which comes before JPMorgan 2016.\n';
    prompt += '\n6. EDUCATION ‚Äî if none found, flag as warning\n';
    prompt += '   - Section order MUST be: SUMMARY, EXPERIENCE, EDUCATION, CERTIFICATIONS, KEY PROJECTS, SKILLS\n';
    prompt += '\n7. EDUCATION ‚Äî scan the ENTIRE resume text including the bottom for any education section. Do not skip it if it appears after experience or certifications.\n';
    prompt += '\n8. GENERAL ‚Äî section headers ALL CAPS, use bullet char, \\n for line breaks\n';
    prompt += '\n9. NEW FIELDS ‚Äî include these in the JSON:\n';
    prompt += 'headlineInsight: 2 sentences to this person (not about the resume). Gap between their background and what the resume shows, then what fixing it unlocks. Warm insider tone.\n';
    prompt += 'humanSignal: 3 sentences. Recruiter narrative inference, what is accidentally communicated, what positioning is missing. Specific to this resume.\n';
    prompt += 'machineRead: Array of ATS flags. Each: {flag, risk: high/medium/low, fix}. 2-5 flags.\n';
    prompt += 'realityCheck: {inYourControl: act on now, marketContext: honest market framing, beyondTheResume: what else matters}. 1-2 sentences each.\n';
    prompt += '\nReturn ONLY valid JSON. The issues field MUST be an array of objects with exactly 2 keys each: "type" (must be exactly "critical", "warning", or "tip") and "text" (the issue description). Example: [{"type":"critical","text":"Missing contact info"},{"type":"warning","text":"Weak summary"}]\n';
    prompt += '\nFor the revisedResume field return a STRUCTURED JSON OBJECT (not a text blob) with these exact keys:\n';
    prompt += '{\n';
    prompt += '  "name": "Full Name",\n';
    prompt += '  "contact": "City, State | Phone | Email | LinkedIn",\n';
    prompt += '  "summary": "Professional summary paragraph",\n';
    prompt += '  "sections": [\n';
    prompt += '    {\n';
    prompt += '      "title": "Professional Experience",\n';
    prompt += '      "entries": [\n';
    prompt += '        {\n';
    prompt += '          "org": "Company Name",\n';
    prompt += '          "title": "Job Title",\n';
    prompt += '          "location": "City, State",\n';
    prompt += '          "dates": "Month Year ‚Äì Month Year",\n';
    prompt += '          "bullets": ["bullet one", "bullet two"]\n';
    prompt += '        }\n';
    prompt += '      ]\n';
    prompt += '    },\n';
    prompt += '    { "title": "Education", "entries": [{ "org": "School", "title": "Degree", "location": "", "dates": "Year", "bullets": [] }] },\n';
    prompt += '    { "title": "Skills", "entries": [], "prose": "skill1, skill2, skill3" }\n';
    prompt += '  ]\n';
    prompt += '}\n';
    prompt += 'Other required fields: score, tenSecondTest, atsNotes, headlineInsight, humanSignal, machineRead, realityCheck\n';
    return prompt;
  }

  // ‚îÄ‚îÄ EMAIL GATE ‚îÄ‚îÄ
  function showEmailGate(data) {
    // Returning user ‚Äî skip gate, renderResults handles save + history reload
    if (currentUserEmail) {
      renderResults(data);
      return;
    }
    pendingResults = data;
    document.getElementById('emailGate').classList.add('active');
    setTimeout(function() {
      var f = document.getElementById('gateName');
      if (f) f.focus();
    }, 100);
  }

  function skipEmailGate() {
    document.getElementById('emailGate').classList.remove('active');
    currentUserEmail = null;
    if (pendingResults) {
      renderResults(pendingResults);
      pendingResults = null;
    }
    setTimeout(showGuestSavePrompt, 800);
  }

  async function submitEmailGate() {
    var name = document.getElementById('gateName').value.trim();
    var email = document.getElementById('gateEmail').value.trim();
    var gateError = document.getElementById('gateError');
    var unlockBtn = document.getElementById('unlockBtn');

    gateError.classList.remove('active');
    gateError.textContent = '';

    if (!email || !email.includes('@')) {
      gateError.textContent = 'Please enter a valid email address.';
      gateError.classList.add('active');
      return;
    }

    unlockBtn.disabled = true;
    unlockBtn.textContent = 'One moment...';

    try {
      var response = await fetch('/api/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, name: name })
      });
      var data = await response.json();
      if (!data.success) throw new Error(data.error || 'Subscription failed');
    } catch (err) {
      console.warn('Subscribe error:', err.message);
      // Still proceed even if subscribe fails
    }

    // Show success screen
    var firstName = name ? name.split(' ')[0] : 'friend';
    document.getElementById('successFirstName').textContent = firstName;

    var gateBox = document.querySelector('#emailGate .email-gate-box');
    Array.from(gateBox.children).forEach(function(el) {
      if (el.id !== 'gateSuccess') el.style.display = 'none';
    });
    document.getElementById('gateSuccess').classList.add('active');

    window._pendingGateEmail = email;
    unlockBtn.disabled = false;
    unlockBtn.textContent = 'Unlock My Resume Audit \u2192';
  }

  function closeSuccessAndShowResults() {
    var capturedEmail = window._pendingGateEmail || '';
    var gateBox = document.querySelector('#emailGate .email-gate-box');
    Array.from(gateBox.children).forEach(function(el) { el.style.display = ''; });
    document.getElementById('gateSuccess').classList.remove('active');
    document.getElementById('emailGate').classList.remove('active');
    currentUserEmail = capturedEmail;
    if (pendingResults) {
      var results = pendingResults;
      pendingResults = null;
      renderResults(results); // renderResults handles save + loadHistory internally
    }
    setTimeout(function() {
      var r = document.getElementById('results');
      if (r) r.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 150);
  }

  function buildResumePreview(r) {
    var lines = [];
    if (r.name) lines.push(r.name.toUpperCase());
    if (r.contact) lines.push(r.contact);
    lines.push('');
    if (r.summary) { lines.push('PROFESSIONAL SUMMARY'); lines.push(r.summary); lines.push(''); }
    (r.sections || []).forEach(function(s) {
      lines.push(s.title.toUpperCase());
      if (s.prose) { lines.push(s.prose); lines.push(''); return; }
      (s.entries || []).forEach(function(e) {
        var titleLine = e.title || '';
        if (e.location) titleLine += ' | ' + e.location;
        lines.push(titleLine);
        var orgLine = e.org || '';
        if (e.dates) orgLine += '   ' + e.dates;
        if (orgLine) lines.push(orgLine);
        if (e.prose) lines.push(e.prose);
        (e.bullets || []).filter(function(b) {
    return b && !b.startsWith('[') && !b.startsWith('‚Ä¢');
      }).forEach(function(b) { lines.push('‚Ä¢ ' + b); });
        lines.push('');
      });
    });
    return lines.join('\n');
  }
  
  function toggleResume() {
    var body = document.getElementById('resumeBody');
    var chevron = document.getElementById('resumeChevron');
    var isOpen = body.style.display === 'block';
    body.style.display = isOpen ? 'none' : 'block';
    chevron.classList.toggle('open', !isOpen);
  }
  
  function downloadResumePDF() {
    var content = document.getElementById('revisedResume').textContent;
    if (!content) return;
    var win = window.open('', '_blank');
    win.document.write('<html><head><title>Resume</title><style>');
    win.document.write('body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.6; max-width: 750px; margin: 40px auto; color: #1a1a1a; }');
    win.document.write('pre { white-space: pre-wrap; font-family: Calibri, Arial, sans-serif; font-size: 11pt; }');
    win.document.write('@media print { body { margin: 0.75in; } }');
    win.document.write('</style></head><body><pre>' + content + '</pre></body></html>');
    win.document.close();
    win.focus();
    setTimeout(function() { win.print(); }, 500);
  }
  
  function escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  
  // ‚îÄ‚îÄ RENDER RESULTS ‚îÄ‚îÄ
  function renderResults(data) {
    var rawScore = data.score || 'Needs Work';
    var scoreNormMap = {
      'Good': 'Decent Foundation', 'Decent': 'Decent Foundation',
      'Needs Improvement': 'Needs Work', 'Excellent': 'Recruiter Ready',
      'Outstanding': 'Recruiter Ready', 'Average': 'Decent Foundation',
      'Fair': 'Needs Work', 'Poor': 'Needs Work'
    };
    var score = scoreNormMap[rawScore] || rawScore;
    var icons = { 'Recruiter Ready': 'üü¢', 'Strong': 'üü£', 'Decent Foundation': 'üü°', 'Needs Work': 'üî¥' };
    var percent = calcScorePercent(score, data.issues);

    if (window.renderScoreBanner) window.renderScoreBanner(score, percent, icons[score] || 'üî¥');

    var issueList = document.getElementById('issueList');
    issueList.innerHTML = '';
    var critCount = 0, warnCount = 0, tipCount = 0;
    (data.issues || []).forEach(function(issue) {
      var li = document.createElement('li');
      // Handle both {type, text} objects and plain strings
      var issueType, issueText;
      if (typeof issue === 'string') {
        issueText = issue;
        var lower = issue.toLowerCase();
        issueType = lower.includes('missing') || lower.includes('no ') || lower.includes('gap') || lower.includes('unclear') ? 'critical' :
                    lower.includes('consider') || lower.includes('suggest') || lower.includes('could') ? 'tip' : 'warning';
      } else {
        issueType = issue.type || 'tip';
        issueText = issue.text || '';
      }
      li.className = 'issue-item ' + issueType;
      li.innerHTML = '<span class="issue-tag">' + issueType + '</span><span>' + issueText + '</span>';
      issueList.appendChild(li);
    });

    // Update pills
    var pc = document.getElementById('issuesPillCritical');
    var pw = document.getElementById('issuesPillWarning');
    var pt = document.getElementById('issuesPillTip');
    (data.issues || []).forEach(function(issue) {
      var t = typeof issue === 'string' ? 'warning' : (issue.type || 'tip');
      if (t === 'critical') critCount++;
      else if (t === 'warning') warnCount++;
      else tipCount++;
    });
    if (critCount > 0) { pc.textContent = critCount + ' critical'; pc.style.display = 'inline'; } else { pc.style.display = 'none'; }
    if (warnCount > 0) { pw.textContent = warnCount + ' warning'; pw.style.display = 'inline'; } else { pw.style.display = 'none'; }
    if (tipCount > 0) { pt.textContent = tipCount + ' tip'; pt.style.display = 'inline'; } else { pt.style.display = 'none'; }

    // ATS Flags card
    var atsFlagsCard = document.getElementById('atsFlagsCard');
    var atsFlagsBody = document.getElementById('atsFlagsBody');
    var atsFlagsCount = document.getElementById('atsFlagsCount');
    var flags = data.machineRead || [];
    if (flags.length > 0) {
      var highCount = flags.filter(function(f) { return f.risk === 'high'; }).length;
      atsFlagsCount.textContent = highCount > 0 ? highCount + ' high risk' : flags.length + ' flags';
      atsFlagsCount.className = 'ats-flags-count' + (highCount === 0 ? ' clean' : '');
      atsFlagsBody.innerHTML = '';
      flags.forEach(function(flag) {
        var item = document.createElement('div');
        item.className = 'ats-flag-item';
        item.innerHTML =
          '<span class="ats-risk-badge ' + (flag.risk || 'low') + '">' + (flag.risk || 'low') + '</span>' +
          '<div class="ats-flag-content">' +
            '<div class="ats-flag-name">' + escapeHtml(flag.flag || '') + '</div>' +
            '<div class="ats-flag-fix">Fix: ' + escapeHtml(flag.fix || '') + '</div>' +
          '</div>';
        atsFlagsBody.appendChild(item);
      });
      atsFlagsCard.style.display = 'block';
    } else {
      atsFlagsCard.style.display = 'none';
    }
    
    // Reality Check
    var rcBlock = document.getElementById('realityCheckBlock');
    var rc = data.realityCheck || {};
    if (rc.inYourControl || rc.marketContext || rc.beyondTheResume) {
      document.getElementById('rcControl').textContent = rc.inYourControl || '';
      document.getElementById('rcMarket').textContent = rc.marketContext || '';
      document.getElementById('rcBeyond').textContent = rc.beyondTheResume || '';
      rcBlock.style.display = 'block';
    } else {
      rcBlock.style.display = 'none';
    }
    
    // Human Signal card
    var hsCard = document.getElementById('humanSignalCard');
    var hsBody = document.getElementById('humanSignalBody');
    if (data.humanSignal && data.humanSignal.trim()) {
      hsBody.textContent = data.humanSignal;
      hsCard.style.display = 'block';
    } else {
      hsCard.style.display = 'none';
    }
        
    var hiBlock = document.getElementById('headlineInsightBlock');
    var hiText = document.getElementById('headlineInsightText');
      if (data.headlineInsight && data.headlineInsight.trim()) {
        hiText.textContent = data.headlineInsight;
        hiBlock.style.display = 'flex';
      } else {
        hiBlock.style.display = 'none';
      }
    document.getElementById('tenSecondResult').textContent = data.tenSecondTest || '';
    // atsResult removed ‚Äî replaced by atsFlagsCard
    var resumeCard = document.getElementById('resumeCard');
    var revisedResumeEl = document.getElementById('revisedResume');
    if (data.revisedResume) {
      if (typeof data.revisedResume === 'object') {
        window.structuredResume = data.revisedResume;
        var preview = buildResumePreview(data.revisedResume);
        revisedResumeEl.textContent = preview;
      } else {
        window.structuredResume = null;
        revisedResumeEl.textContent = (data.revisedResume || '').replace(/\\n/g, '\n');
      }
      resumeCard.style.display = 'block';
    } else {
      resumeCard.style.display = 'none';
    }

    document.getElementById('results').classList.add('active');
    setTimeout(function() {
      document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);

    if (currentUserEmail) {
      // Show new audit bar and sign out immediately
      var bar = document.getElementById('newAuditBar');
      if (bar) bar.classList.add('active');
      var signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) signOutBtn.style.display = '';
      // Save then reload history so new entry appears in real time
      saveAuditToSupabase(currentUserEmail, data).then(function() {
        loadHistory(currentUserEmail);
      });
    }
  }

  // ‚îÄ‚îÄ COPY / DOWNLOAD ‚îÄ‚îÄ
  function copyResume() {
    var text = document.getElementById('revisedResume').textContent;
    navigator.clipboard.writeText(text).then(function() {
      var btn = document.getElementById('copyBtn');
      btn.textContent = '‚úì Copied!';
      btn.classList.add('success');
      setTimeout(function() { btn.textContent = 'üìã Copy'; btn.classList.remove('success'); }, 2500);
    });
  }

  function downloadResume() {
    var text = document.getElementById('revisedResume').textContent;
    var lines = text.split('\n');
    var nameRaw = lines[0].trim().replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_') || 'resume';
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF({ unit: 'pt', format: 'letter' });
    var marginX = 54, marginY = 54;
    var pageWidth = doc.internal.pageSize.getWidth();
    var pageHeight = doc.internal.pageSize.getHeight();
    var contentWidth = pageWidth - marginX * 2;
    var y = marginY;
    var lineIndex = 0;
    var inExperience = false;
    var lastWasCompany = false;
    var lastWasSectionHeader = false;
    var sectionHeaders = ['EXPERIENCE','EDUCATION','SKILLS','SUMMARY','CERTIFICATIONS','PROJECTS','AWARDS','VOLUNTEER','PUBLICATIONS'];

    function checkPage(needed) { if (y + needed > pageHeight - marginY) { doc.addPage(); y = marginY; } }
    function isAllCaps(s) { return s.length >= 2 && s === s.toUpperCase() && /^[A-Z0-9\s&\/\-,\.]+$/.test(s) && /[A-Z]/.test(s); }
    function isDateLine(s) { return /^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|\d{4})/i.test(s) || /\d{4}\s*[-‚Äì]\s*(Present|\d{4})/i.test(s); }
    function isRoleTitle(s) { return s.includes('|') && s.length < 100; }
    function isBullet(s) { return s.startsWith('‚Ä¢') || s.startsWith('-') || s.startsWith('¬∑'); }

    lines.forEach(function(line) {
      var trimmed = line.trim();
      if (lineIndex === 0 && trimmed) {
        lineIndex++;
        doc.setFont('times','bold'); doc.setFontSize(20); doc.setTextColor(36,36,36);
        checkPage(30); doc.text(trimmed, pageWidth/2, y, {align:'center'}); y += 8;
        doc.setDrawColor(155,109,187); doc.setLineWidth(1.5); doc.line(marginX+40, y+4, pageWidth-marginX-40, y+4); y += 14; return;
      }
      if (lineIndex === 1 && trimmed && !isBullet(trimmed)) {
        lineIndex++;
        doc.setFont('times','normal'); doc.setFontSize(9); doc.setTextColor(110,100,95);
        checkPage(14); doc.text(trimmed, pageWidth/2, y, {align:'center'}); y += 20; return;
      }
      if (!trimmed) { y += lastWasCompany ? 2 : 5; lastWasCompany = false; return; }
      lineIndex++;
      var isSectionHeader = sectionHeaders.some(function(s) { return trimmed === s; }) || (isAllCaps(trimmed) && trimmed.length < 40 && !isDateLine(trimmed));
      if (isSectionHeader) {
        y += lastWasSectionHeader ? 6 : 14; checkPage(24);
        doc.setFont('helvetica','bold'); doc.setFontSize(8.5); doc.setTextColor(120,70,160); doc.text(trimmed, marginX, y);
        doc.setDrawColor(206,177,221); doc.setLineWidth(0.6); doc.line(marginX, y+4, pageWidth-marginX, y+4); y += 16;
        inExperience = (trimmed === 'EXPERIENCE'); lastWasCompany = false; lastWasSectionHeader = true; return;
      }
      lastWasSectionHeader = false;
      if (inExperience && isAllCaps(trimmed) && !isDateLine(trimmed)) {
        y += 10; checkPage(18);
        doc.setFont('helvetica','bold'); doc.setFontSize(10.5); doc.setTextColor(36,36,36); doc.text(trimmed, marginX, y); y += 14; lastWasCompany = true; return;
      }
      if (isDateLine(trimmed)) {
        checkPage(13); doc.setFont('times','italic'); doc.setFontSize(9); doc.setTextColor(120,112,105); doc.text(trimmed, marginX+10, y); y += 13; lastWasCompany = false; return;
      }
      if (isRoleTitle(trimmed)) {
        y += lastWasCompany ? 0 : 8; checkPage(15);
        doc.setFont('times','bold'); doc.setFontSize(10.5); doc.setTextColor(36,36,36);
        var parts = trimmed.split('|'); var titlePart = parts[0].trim(); var locPart = parts.slice(1).join('|').trim();
        doc.text(titlePart, marginX+10, y);
        if (locPart) { doc.setFont('times','normal'); doc.setFontSize(9.5); doc.setTextColor(120,112,105); doc.text(locPart, pageWidth-marginX, y, {align:'right'}); }
        y += 14; lastWasCompany = false; return;
      }
      if (isBullet(trimmed)) {
        var bulletText = trimmed.substring(1).trim();
        doc.setFont('times','normal'); doc.setFontSize(10); doc.setTextColor(50,44,40);
        var wrapped = doc.splitTextToSize(bulletText, contentWidth - 22);
        wrapped.forEach(function(wline, i) {
          checkPage(13.5);
          if (i === 0) { doc.setTextColor(155,109,187); doc.text('‚Ä¢', marginX+10, y); doc.setTextColor(50,44,40); doc.text(wline, marginX+20, y); }
          else { doc.text(wline, marginX+20, y); }
          y += 13.5;
        });
        y += 1.5; lastWasCompany = false; return;
      }
      doc.setFont('times','normal'); doc.setFontSize(10); doc.setTextColor(50,44,40);
      var wrapped2 = doc.splitTextToSize(trimmed, contentWidth);
      wrapped2.forEach(function(wline) { checkPage(14); doc.text(wline, marginX, y); y += 14; });
      lastWasCompany = false;
    });
    doc.save(nameRaw + '_rewritten.pdf');
    var btn = document.getElementById('downloadBtn');
    btn.textContent = '‚úì Downloaded!'; btn.classList.add('success');
    setTimeout(function() { btn.textContent = '‚¨á Download PDF'; btn.classList.remove('success'); }, 2500);
  }

  // ‚îÄ‚îÄ GUEST SAVE PROMPT ‚îÄ‚îÄ
  function showGuestSavePrompt() {
    var p = document.getElementById('guestSavePrompt');
    if (p) p.classList.add('active');
  }
  function dismissSavePrompt() {
    var p = document.getElementById('guestSavePrompt');
    if (p) p.classList.remove('active');
  }
  function showGuestSignup() {
    dismissSavePrompt();
    document.getElementById('emailGate').classList.add('active');
    var h = document.querySelector('#emailGate h2');
    if (h) h.innerHTML = 'Save your audit.<br><em>It only takes a second.</em>';
    setTimeout(function() { document.getElementById('gateName').focus(); }, 100);
  }

  // ‚îÄ‚îÄ RESET ‚îÄ‚îÄ
  // ‚îÄ‚îÄ START NEW AUDIT (keeps session + history) ‚îÄ‚îÄ
  function startNewAudit() {
    uploadedText = '';
    pendingResults = null;
    fileInput.value = '';
    document.getElementById('resumeText').value = '';
    document.getElementById('targetRole').value = '';
    document.getElementById('industry').value = '';
    document.getElementById('focusNote').value = '';
    document.getElementById('fileStatus').className = 'file-status';
    document.getElementById('results').classList.remove('active');
    document.getElementById('errorBox').classList.remove('active');
    if (window.clearScoreBanner) window.clearScoreBanner();
    dismissSavePrompt();
    // Scroll to upload zone so they can drop a new resume
    setTimeout(function() {
      document.getElementById('dropZone').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }

  // ‚îÄ‚îÄ SIGN OUT (clears session, hides history) ‚îÄ‚îÄ
  function signOut() {
    currentUserEmail = null;
    uploadedText = '';
    pendingResults = null;
    fileInput.value = '';
    document.getElementById('resumeText').value = '';
    document.getElementById('targetRole').value = '';
    document.getElementById('industry').value = '';
    document.getElementById('focusNote').value = '';
    document.getElementById('fileStatus').className = 'file-status';
    document.getElementById('results').classList.remove('active');
    document.getElementById('errorBox').classList.remove('active');
    document.getElementById('historyPanel').classList.remove('active');
    document.getElementById('newAuditBar').classList.remove('active');
    document.getElementById('signOutBtn').style.display = 'none';
    if (window.clearScoreBanner) window.clearScoreBanner();
    dismissSavePrompt();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ‚îÄ‚îÄ LEGACY resetForm ‚Äî kept for safety ‚îÄ‚îÄ
  function resetForm() { startNewAudit(); }

  // ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ
  var scoreRanges = {
    'Recruiter Ready': { min: 90, max: 99 },
    'Strong':          { min: 75, max: 89 },
    'Decent Foundation': { min: 60, max: 74 },
    'Needs Work':      { min: 30, max: 59 }
  };
  var scoreMap = { 'Recruiter Ready': 92, 'Strong': 78, 'Decent Foundation': 63, 'Needs Work': 45 };
  var scoreClassMap = { 'Recruiter Ready': 'recruiter-ready', 'Strong': 'strong', 'Decent Foundation': 'decent', 'Needs Work': 'needs-work' };

  function calcScorePercent(score, issues) {
    var range = scoreRanges[score] || scoreRanges['Needs Work'];
    var criticalCount = (issues || []).filter(function(i) { return i.type === 'critical'; }).length;
    var warningCount  = (issues || []).filter(function(i) { return i.type === 'warning'; }).length;
    var penalty = (criticalCount * 4) + (warningCount * 2);
    return Math.min(range.max, Math.max(range.min, range.max - penalty));
  }

  // ‚îÄ‚îÄ SAVE AUDIT ‚îÄ‚îÄ
  async function saveAuditToSupabase(email, auditData) {
    try {
      var targetRole = document.getElementById('targetRole')
        ? document.getElementById('targetRole').value.trim() : '';
      var enriched = Object.assign({}, auditData, { targetRole: targetRole || null });
      var res = await fetch('/api/saveAudit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, auditData: enriched })
      });
      return await res.json();
    } catch (err) {
      console.warn('Save audit error:', err.message);
    }
  }

  // ‚îÄ‚îÄ LOAD HISTORY ‚îÄ‚îÄ
  async function loadHistory(email) {
    try {
      var SUPABASE_URL = window.__SB_URL__ || '';
      var SUPABASE_KEY = window.__SB_KEY__ || '';
      if (!SUPABASE_URL) return;
      var response = await fetch(
        SUPABASE_URL + '/rest/v1/audits?email=eq.' + encodeURIComponent(email) + '&order=created_at.desc&limit=20',
        { headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY } }
      );
      var audits = await response.json();
      renderHistory(email, audits);
    } catch (err) {
      console.warn('Load history error:', err.message);
    }
  }

  // ‚îÄ‚îÄ RENDER HISTORY ‚îÄ‚îÄ
  function renderHistory(email, audits) {
    var panel = document.getElementById('historyPanel');
    var list = document.getElementById('historyList');
    document.getElementById('historyUser').textContent = email;
    list.innerHTML = '';
    currentUserEmail = email;

    if (!audits || audits.length === 0) {
      list.innerHTML = '<div class="history-empty">No past audits yet &mdash; run your first one below!</div>';
      panel.classList.add('active');
      return;
    }

    // Sort ascending for delta calc
    var sorted = audits.slice().sort(function(a, b) { return new Date(a.created_at) - new Date(b.created_at); });
    var percents = sorted.map(function(a) { return a.score_percent || scoreMap[a.score] || 45; });

    // Render newest first
    sorted.slice().reverse().forEach(function(audit) {
      var origIdx = sorted.indexOf(audit);
      var percent = percents[origIdx];
      var prevPercent = origIdx > 0 ? percents[origIdx - 1] : null;
      var delta = prevPercent !== null ? percent - prevPercent : null;

      var date = new Date(audit.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      var scoreClass = scoreClassMap[audit.score] || 'needs-work';
      var issues = audit.issues || [];
      var topCritical = issues.find(function(i) { return i.type === 'critical'; });

      // Delta badge
      var deltaHtml = '';
      if (delta !== null) {
        var sign = delta >= 0 ? '+' : '';
        var cls = delta >= 0 ? 'up' : 'down';
        deltaHtml = '<span class="history-card-delta ' + cls + '">' + sign + delta + 'pts</span>';
      }

      // Issues list
      var issuesHtml = issues.length > 0
        ? '<div class="history-issue-list">' + issues.map(function(issue) {
            return '<div class="history-issue"><span class="history-issue-tag ' + (issue.type||'tip') + '">' + (issue.type||'tip') + '</span><span>' + escapeHtml(issue.text) + '</span></div>';
          }).join('') + '</div>'
        : '<p style="font-size:13px;color:var(--muted)">No issues recorded.</p>';

      // Resume text
      var resumeText = (audit.revised_resume || '').replace(/\\n/g, '\n');
      var cardId = 'hcard-' + (audit.id || origIdx);
      var resumeId = 'hresume-' + (audit.id || origIdx);

      var card = document.createElement('div');
      card.className = 'history-card';
      card.id = cardId;
      card.innerHTML =
        '<div class="history-card-header" onclick="toggleHistoryCard(\'' + cardId + '\')">' +
          '<div class="history-card-left">' +
            '<div class="history-card-top">' +
              '<span class="history-card-score ' + scoreClass + '">' + escapeHtml(audit.score || 'Needs Work') + '</span>' +
              '<span class="history-card-percent">' + percent + '%</span>' +
              (audit.target_role ? '<span class="history-card-role">' + escapeHtml(audit.target_role) + '</span>' : '') +
            '</div>' +
            '<div class="history-card-meta">' +
              '<span class="history-card-date">' + date + '</span>' +
              (topCritical ? '<span class="history-card-preview">\u26a0 ' + escapeHtml(topCritical.text.substring(0,65)) + (topCritical.text.length > 65 ? '...' : '') + '</span>' : '') +
            '</div>' +
          '</div>' +
          '<div class="history-card-right">' + deltaHtml + '<span class="history-card-chevron">\u25bc</span></div>' +
        '</div>' +
        '<div class="history-card-body">' +
          '<div class="history-card-section">' +
            '<div class="history-card-section-title">Issues Found</div>' +
            issuesHtml +
          '</div>' +
          (resumeText ? (
            '<div class="history-card-section">' +
              '<button class="history-resume-toggle" onclick="toggleHistoryResume(\'' + resumeId + '\', this)">' +
                '\uD83D\uDCC4 View Rewritten Resume' +
              '</button>' +
              '<div class="history-resume-box" id="' + resumeId + '">' + escapeHtml(resumeText) + '</div>' +
            '</div>'
          ) : '') +
        '</div>';

      list.appendChild(card);
    });

    panel.classList.add('active');

    // Show new audit bar and sign out if results are already visible
    var newAuditBar = document.getElementById('newAuditBar');
    if (newAuditBar) newAuditBar.classList.add('active');

    // Show sign out button in results footer
    var signOutBtn = document.getElementById('signOutBtn');
    if (signOutBtn) signOutBtn.style.display = '';
  }

  function toggleHistoryCard(cardId) {
    var card = document.getElementById(cardId);
    if (card) card.classList.toggle('open');
  }

  function toggleHistoryResume(resumeId, btn) {
    var box = document.getElementById(resumeId);
    if (!box) return;
    box.classList.toggle('open');
    btn.textContent = box.classList.contains('open') ? '\uD83D\uDCC4 Hide Rewritten Resume' : '\uD83D\uDCC4 View Rewritten Resume';
  }

  // ‚îÄ‚îÄ ROTATING RECRUITER FACTS ‚îÄ‚îÄ
  var recruitFacts = [
      "75% of resumes are rejected by ATS before a human ever sees them.",
      "Recruiters spend an average of 7 seconds on an initial resume scan.",
      "Resumes with measurable results get 40% more callbacks than those without.",
      "A single typo can get your resume rejected at 58% of companies.",
      "Most ATS systems can't read tables, text boxes, or multi-column layouts.",
      "Keywords from the job description matter ‚Äî ATS scores for exact matches.",
      "The top third of your resume determines whether the rest gets read.",
      "Applicants with a LinkedIn URL on their resume get 71% more interview requests."
   ];
  var factInterval = null;
  var factIndex = 0;
    
  function startFactRotation() {
      var el = document.getElementById('recruitFact');
      if (!el) return;
      factIndex = Math.floor(Math.random() * recruitFacts.length);
      el.textContent = recruitFacts[factIndex];
      el.style.opacity = '1';
      factInterval = setInterval(function() {
        el.style.opacity = '0';
        setTimeout(function() {
          factIndex = (factIndex + 1) % recruitFacts.length;
          el.textContent = recruitFacts[factIndex];
          el.style.opacity = '1';
        }, 500);
      }, 3500);
    }
    
  function stopFactRotation() {
      if (factInterval) { clearInterval(factInterval); factInterval = null; }
      var el = document.getElementById('recruitFact');
      if (el) { el.textContent = ''; el.style.opacity = '0'; }
    }
  
  function toggleHumanSignal() {
    var body = document.getElementById('humanSignalBody');
    var chevron = document.getElementById('humanSignalChevron');
    var isOpen = body.style.display === 'block';
    if (isOpen) {
      body.style.display = 'none';
      chevron.classList.remove('open');
    } else {
      body.style.display = 'block';
      chevron.classList.add('open');
    }
  }

  function toggleAtsFlags() {
  var body = document.getElementById('atsFlagsBody');
  var chevron = document.getElementById('atsFlagsChevron');
  var isOpen = body.style.display === 'block';
  body.style.display = isOpen ? 'none' : 'block';
  chevron.classList.toggle('open', !isOpen);
  }

  function toggleIssues() {
  var body = document.getElementById('issuesBody');
  var chevron = document.getElementById('issuesChevron');
  var isOpen = body.style.display === 'block';
  body.style.display = isOpen ? 'none' : 'block';
  chevron.classList.toggle('open', !isOpen);
  }

  // ‚îÄ‚îÄ SIGNIN GATE ‚îÄ‚îÄ
  function showSigninGate() {
    document.getElementById('signinGate').classList.add('active');
    setTimeout(function() { document.getElementById('signinEmail').focus(); }, 100);
  }
  function closeSignin() {
    document.getElementById('signinGate').classList.remove('active');
    document.getElementById('signinError').textContent = '';
  }
  async function submitSignin() {
    var email = document.getElementById('signinEmail').value.trim();
    var errorEl = document.getElementById('signinError');
    errorEl.textContent = '';
    if (!email || !email.includes('@')) {
      errorEl.textContent = 'Please enter a valid email address.';
      errorEl.classList.add('active');
      return;
    }
    document.getElementById('signinGate').classList.remove('active');
    currentUserEmail = email;
    loadHistory(email);
  }
</script>

<script type="text/babel">
  const { useState, useEffect } = React;

  function ScoreBanner({ score, percent, icon }) {
    const [animated, setAnimated] = useState(false);
    const [displayPercent, setDisplayPercent] = useState(0);

    const classMap = {
      'Recruiter Ready': 'recruiter-ready', 'Strong': 'strong',
      'Decent Foundation': 'decent', 'Needs Work': 'needs-work'
    };
    const colorMap = {
      'Recruiter Ready': '#7aab8a', 'Strong': '#9b6dbb',
      'Decent Foundation': '#c97a3a', 'Needs Work': '#e05252'
    };

    useEffect(() => {
      if (!score) return;
      setAnimated(false); setDisplayPercent(0);
      const timer = setTimeout(() => setAnimated(true), 50);
      let start = 0;
      const step = (percent / 1000) * 16;
      const counter = setInterval(() => {
        start += step;
        if (start >= percent) { setDisplayPercent(percent); clearInterval(counter); }
        else { setDisplayPercent(Math.floor(start)); }
      }, 16);
      return () => { clearTimeout(timer); clearInterval(counter); };
    }, [score, percent]);

    if (!score) return null;
    const color = colorMap[score] || '#e05252';

    return (
      <div className={`score-banner ${classMap[score] || 'needs-work'}`} style={{
        opacity: animated ? 1 : 0,
        transform: animated ? 'translateY(0)' : 'translateY(12px)',
        transition: 'opacity 0.4s ease, transform 0.4s ease'
      }}>
        <div>
          <div className="score-label">Recruiter Readability Score</div>
          <div className="score-value" style={{ color }}>{score}</div>
          <div className="score-percent-badge">{displayPercent}%</div>
        </div>
        <div style={{ textAlign: 'center' }}>
          <div className="score-icon">{icon}</div>
          <div style={{ marginTop: '8px', fontSize: '11px', fontWeight: '600', color, letterSpacing: '0.05em' }}>
            {score === 'Recruiter Ready' && 'Interview Ready'}
            {score === 'Strong' && 'Nearly There'}
            {score === 'Decent Foundation' && 'Needs Polish'}
            {score === 'Needs Work' && 'Needs Rebuild'}
          </div>
        </div>
      </div>
    );
  }

  window.renderScoreBanner = function(score, percent, icon) {
    const root = document.getElementById('scoreBannerRoot');
    if (!root) return;
    ReactDOM.render(<ScoreBanner score={score} percent={percent} icon={icon} />, root);
  };
  window.clearScoreBanner = function() {
    const root = document.getElementById('scoreBannerRoot');
    if (root) ReactDOM.unmountComponentAtNode(root);
  };
</script>

</body>
</html>
